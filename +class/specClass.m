classdef specClass

    % Author.: Eric Magalhães Delgado
    % Date...: July 15, 2023
    % Version: 1.00

    properties
        ID
        Task        = class.taskClass.empty                                 % See "auxApp.winAddTask.mlapp"
        Observation = struct('Created',    '', ...                          % Datestring data type - Format: '24/02/2023 14:00:00'
                             'BeginTime', NaT, ...                          % Datetime data type
                             'EndTime',   NaT, ...                          % Datetime data type
                             'StartUp',   NaT)                              % Datetime data type
    
        hReceiver                                                           % Handle to Receiver
        hStreaming                                                          % Handle to UDP socket (generated by R&S EB500)
        hGPS                                                                % Handle to GPS

        lastGPS     = struct('Status', 0, 'Latitude', -1, 'Longitude', -1, 'TimeStamp', '')
        GeneralSCPI = struct('resetSET', {}, 'startupSET', {}, 'syncSET', {}, 'attGET', {}, 'dataGET', {})
        Band        = class.bandClass.empty                                 % See "fcn.receiverConfig_SpecificBand.m"

        Error       = struct('CreatedTime', NaT, 'LastTime', NaT, 'Count', 0)
        Status      = ''                                                    % 'Na fila' | 'Em andamento' | 'Concluída' | 'Cancelada' | 'Erro'
        LOG         = struct('type', {}, 'time', {}, 'msg',  {})
    end


    methods
        %-----------------------------------------------------------------%
        function [obj, idx] = AddOrEditTask(obj, infoEdition, newTask, EMSatObj)
            switch infoEdition.type
                case 'new'
                    idx = numel(obj)+1;
                    obj(idx).ID = idx;
                    obj(idx).Observation.Created = datestr(now, 'dd/mm/yyyy HH:MM:SS');

                case 'edit'
                    idx = infoEdition.idx;
            end
            
            obj(idx).Task       = newTask;
            
            obj(idx).hReceiver  = newTask.Receiver.Handle;
            obj(idx).hStreaming = newTask.Streaming.Handle;
            obj(idx).hGPS       = newTask.GPS.Handle;

            obj(idx).Observation.BeginTime = datetime(newTask.Script.Observation.BeginTime, 'InputFormat', 'dd/MM/yyyy HH:mm:ss', 'Format', 'dd/MM/yyyy HH:mm:ss');
            obj(idx).Observation.EndTime   = datetime(newTask.Script.Observation.EndTime,   'InputFormat', 'dd/MM/yyyy HH:mm:ss', 'Format', 'dd/MM/yyyy HH:mm:ss');

            obj = obj.startup_lastGPS(idx, newTask.Script.GPS);
            obj = obj.startup_ReceiverTest(idx, EMSatObj);
        end
    end


    methods (Access = protected)
        %-----------------------------------------------------------------%
        function obj = startup_lastGPS(obj, idx, GPS)
            if strcmp(GPS.Type, 'Manual')
                obj(idx).lastGPS.Status    = -1;
                obj(idx).lastGPS.Latitude  = GPS.Latitude;
                obj(idx).lastGPS.Longitude = GPS.Longitude;
            end
            obj(idx).lastGPS.TimeStamp = obj(idx).Observation.Created;
        end


        %-----------------------------------------------------------------%
        function obj = startup_ReceiverTest(obj, idx, EMSatObj)
            warnMsg  = {};
            errorMsg = '';
            try
                obj = fcn.receiverConfig_General(obj, idx);
                [obj, warnMsg] = fcn.receiverConfig_SpecificBand(obj, idx, EMSatObj);
            catch ME
                errorMsg = ME.message;
            end
            
            % STATUS/LOG
            if isempty(errorMsg)
                obj(idx).Status = 'Na fila';
                obj(idx).LOG(end+1) = struct('type', 'task',    'time', obj(idx).Observation.Created, 'msg', 'Incluída na fila a tarefa.');
            else
                obj(idx).Status = 'Erro';
                obj(idx).LOG(end+1) = struct('type', 'error',   'time', obj(idx).Observation.Created, 'msg', errorMsg);
            end
            
            if ~isempty(warnMsg)
                obj(idx).LOG(end+1) = struct('type', 'warning', 'time', obj(idx).Observation.Created, 'msg', warnMsg);
            end
        end
    end
end